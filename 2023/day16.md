# 模糊測試

模糊測試，也稱為「模糊測試」，是一種軟體測試技術，涉及向電腦程式提供無效、意外或隨機數據作為輸入。
模糊測試的目標是通過導致程式崩潰或表現出意外行為來識別程式中的安全漏洞和其他錯誤。

模糊測試可以手動執行，也可以使用測試庫/框架為我們製作輸入。

為了更好地理解模糊測試，讓我們舉一個例子，想像這段代碼：

```go
func DontPanic(s string) {
    if len(s) == 4 {
        if s[0] == 'f' {
            if s[1] == 'u' {
                if s[2] == 'z' {
                    if s[3] == 'z' {
                        panic("error: wrong input")
                    }
                }
            }
        }
    }
}
```

這是一個 Go 函數，接受一個 `string` 作為唯一參數。

查看函數，看起來函數只會在一種情況下 `panic`（例如崩潰）- 如果提供的輸入是單詞 `fuzz`。

顯然，這個函數非常簡單，通過查看它我們可以看到它的行為。
然而，在更複雜的系統中，這樣的失敗點可能並不明顯，並且可能被測試它/編寫單元測試用例的人遺漏。

這就是模糊測試派上用場的地方。

Go 模糊測試庫（自 Go 1.18 以來是標準語言庫的一部分）為測試用例生成許多輸入，然後根據覆蓋率和結果確定哪些輸入是「有趣的」。

如果我們為這個函數編寫模糊測試，將會發生什麼：

1. 模糊測試庫將開始提供隨機字串，從較小的字串開始並增加它們的大小。
2. 一旦庫提供長度為 4 的字串，它會注意到測試覆蓋率的變化（`if (len(s) == 4)` 現在是 `true`），並將繼續生成此長度的輸入。
3. 一旦庫提供長度為 4 且以 `f` 開頭的字串，它會注意到測試覆蓋率的另一個變化（`if s[0] == "f"` 現在是 `true`），並將繼續生成以 `f` 開頭的輸入。
4. 對於 `u` 和雙 `z` 會重複相同的事情。
5. 一旦它提供 `fuzz` 作為輸入，函數就會 panic，測試將失敗。
6. 我們已經成功 _模糊測試_ 了！

模糊測試的另一個最佳實踐是保存使代碼崩潰的輸入，並每次都運行它們，以確保我們通過模糊測試捕獲的原始錯誤永遠不會再次引入我們的代碼。

這也可能是模糊測試框架的一個功能。

大多數模糊測試庫允許我們添加我們想要測試的特定值。
這也有助於庫，因為它向它們顯示我們已經知道是「有趣的」值，因此它們可以根據這些值對生成的值進行建模。

## 當模糊測試不夠時

模糊測試是一種有用的技術，但在某些情況下它可能沒有幫助。

例如，如果使我們的代碼失敗的輸入過於具體並且沒有線索可以幫助，模糊測試庫可能無法猜測它。

如果我們將上一段中的示例代碼更改為如下內容：

```go
func DontPanic(s input) {
    if (len(s) == 4) && s[0] == 'f' && s[1] == 'u' && s[2] == 'z' && s[3] == 'z' {
        panic("error")
    }
}
```

或者只是：

```go
func DontPanic(s input) {
    if s == "fuzz" {
        panic("error")
    }
}
```

那麼模糊測試不會幫助我們，因為它生成確切字串 `fuzz` 的機會很小，沒有任何線索，
並且在上一種情況下觸發代碼覆蓋率變化的輸入（大小為 4 的字串、以 `z` 開頭的大小為 4 的字串等）都不會觸發代碼覆蓋率（因為我們只有一個 `if` 檢查，而上一示例中有 5 個）。

因此，重要的是要理解，雖然模糊測試是檢測代碼中異常和邊緣情況的好方法，但它不是 100% 正確代碼的萬能藥。

## 實際示例

如果您想親自動手進行 Go 中的模糊測試，請查看 [我在該主題上的示例儲存庫](https://github.com/asankov/go-fuzzing-101/tree/v1)。

它包含我在本文中使用的示例 + 觸發失敗的模糊測試，以及如何自己運行測試的說明。

## 資源

- <https://en.wikipedia.org/wiki/Fuzzing>
- [Fuzzing in Go by Valentin Deleplace, Devoxx Belgium 2022](https://www.youtube.com/watch?v=Zlf3s4EjnFU)
- [Write applications faster and securely with Go by Cody Oss, Go Day 2022](https://www.youtube.com/watch?v=aw7lFSFGKZs)

在 [Day 17](day17.md) 見。
