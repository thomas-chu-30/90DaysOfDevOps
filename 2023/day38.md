# 使用動態憑證提高組織的安全態勢

正如我們昨天談到的，Vault 通常用作整合靜態、長期有效憑證的平台。然而，您仍然面臨根據組織安全政策輪換這些憑證的管理噩夢。這種憑證輪換「傳統」是一項手動、費力的任務，容易出錯，導致應用程式停機。但是...

如果您可以完全擺脫靜態憑證會怎樣？如果您的應用程式每週只需要一次數據庫訪問來運行報告，為什麼您要給它一個在 24/7/365 有效的憑證？讓您的應用程式按需為需要運行的系統生成動態、自毀的憑證不是很好嗎？

好吧，使用 Vault 中可用的許多密鑰引擎，這一切都是可能的。

## 動態密鑰簡介

動態密鑰是代表請求的 Vault 客戶端按需生成的憑證。與簡單地從 KV 存儲中讀取靜態憑證不同，Vault 可以對請求的平台進行 API 調用，創建憑證，並將憑證傳遞回用戶。在此過程中，Vault 將租約（TTL）附加到憑證，這表示憑證有效的時間長度。然後，Vault 客戶端可以使用憑證直接與平台通信以執行其預期功能。一旦憑證的租約過期，Vault 會回調平台並刪除憑證，使其失效。

## 使用動態密鑰的好處

遷移到動態憑證有很多好處。明顯的好處是不需要手動輪換的長期有效憑證。由於這些長期有效的憑證通常在團隊和應用程式堆疊之間共享，它們更容易被濫用或誤用。但是，當您遷移到動態憑證時，使用動態憑證時，每個應用程式實例都可以檢索唯一的憑證來訪問所需的平台。如果該應用程式實例被終止（考慮容器化或自動擴展），憑證將被 Vault 失效，不會影響環境中的其他實例或應用程式。

動態密鑰還消除了手動輪換憑證的過程。與每年輪換一次憑證不同，這些高度特權的憑證現在每月、每週或每小時輪換一次。例如，考慮您如何使用 Terraform 在公共或私有雲上部署資源。您可能在目標平台上創建一個憑證，並通過環境變數或 TFC/TFE 中的敏感工作區變數重複使用它。但是，為什麼您要給 Terraform 高度特權的憑證，這些憑證在 24/7/365 有效，而您的 Terraform 運行每天只需要 15 分鐘？切換到動態憑證。使用 Vault 密鑰引擎和 Terraform 的 Vault 提供者的組合，您可以讓 Terraform 為其需要訪問的平台生成動態憑證以進行資源部署或管理。

## 配置動態密鑰引擎

有了這個冗長的介紹，讓我們談談如何實現使用動態憑證的目標。HashiCorp Vault 提供了大量生成動態憑證或數據的密鑰引擎，例如：
•	AWS
•	Azure
•	GCP
•	Active Directory
•	AliCloud
•	Consul
•	數據庫（支援約 15 個不同的數據庫平台）
•	PKI 證書
•	Kubernetes
•	RabbitMQ
•	SSH
•	Terraform Cloud

我想您會同意，對於單個平台來說，這有很多選項。很酷的是，您可以使用任意數量的這些密鑰引擎，甚至可以啟用許多相同類型的密鑰引擎。讓我們看看如何啟用其中一個，使用 AWS 作為範例。

每個密鑰引擎必須在路徑上啟用，然後使用該路徑完成與密鑰引擎的所有交互。因此，每個密鑰引擎必須在唯一路徑上啟用，以便 Vault 知道將請求路由到哪裡。要啟用密鑰引擎，請使用以下命令結構 `vault secrets enable -path=<name> <secrets_engine_type>`。在 `cloud` 路徑上啟用 AWS 密鑰引擎將如下所示：

`vault secrets engine -path=cloud aws`

> 請注意，如果您不提供路徑標誌，密鑰引擎將在預設路徑上啟用，該路徑與密鑰引擎類型的名稱相同。例如，AWS 密鑰引擎將在 aws/ 上啟用。

好的，所以我們已經啟用了密鑰引擎，讓我們開始配置它。密鑰引擎的配置通常需要幾件事。首先是 Vault 與平台（在這種情況下是 AWS）通信的方式。就像任何其他 AWS 客戶端一樣，Vault 需要憑證來對目標平台進行身份驗證以執行操作。對於 AWS，您可以為 Vault 提供訪問密鑰和秘密密鑰，或者如果 Vault 部署在 AWS 上，則使用 IAM 角色。

除了身份驗證之外，Vault 還需要在平台上執行操作的適當授權。對於 AWS，這等同於在您將提供給 Vault 的憑證上附加 IAM 政策。根據您想要生成的憑證類型（Vault 為 AWS 支援 3 種類型），政策應該允許創建/管理/刪除用戶、生成密鑰、管理密鑰等權限。這些政策由 HashiCorp 在其文檔中提供。我在 [我的 GitHub](https://github.com/btkrausen/hashicorp) 上也有一些 Vault 的預定義政策。

要為 Vault 提供訪問 AWS 帳戶的憑證，您可以使用以下命令：

```
vault write aws/config/root \
    access_key=AKIAIOSFODNN7EXAMPLE \
   secret_key=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY \
    region=us-east-1
```

> 雖然您可以使用此配置添加憑證，但您也可以使用環境變數提供它們。

好的，現在 Vault 可以訪問我們的 AWS 帳戶，它還不知道要創建什麼憑證以及這些憑證在 AWS 帳戶中應該具有的訪問級別。每個唯一的憑證要求都將在角色中定義（這是 Vault 角色，不要與 AWS 角色混淆）。角色用於將用戶映射到平台上的權限集合。例如，您可以為開發人員創建一個角色，該角色提供對 AWS 帳戶的只讀訪問，或者您可以為 Terraform 創建一個角色，該角色提供更廣泛的權限集來創建、管理和刪除資源。角色可以被許多應用程式使用，但請記住，您想要給 Vault 客戶端的每個唯一權限集都需要不同的角色。

讓我們創建我們的第一個角色。此角色將用於需要對 AWS 進行只讀訪問的開發人員，以便他們可以獲取日誌來故障排除應用程式。角色名稱將是 `developer`。

```
vault write aws/roles/developer \
    policy_arns=arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess \
   credential_type=iam_user
```

> 在這個範例中，我使用了 IAM_USER 憑證類型，但對於生產環境，我建議使用 ASSUME_ROLE，這樣您就可以有一個

當開發人員請求憑證時，它們將與名為 ` arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess` 的 AWS 管理政策綁定。您可以使用 AWS 管理政策、客戶管理政策，或者簡單地在 Vault 角色配置中提供政策，Vault 將在創建用戶時創建內聯政策。

## 讓我們獲取憑證

好的，我們已經掛載（啟用！）了密鑰引擎，配置了密鑰引擎以訪問我們的帳戶，現在我們有了一個角色。下一步邏輯步驟是測試它並獲得我們的第一組動態憑證。由於我們創建的角色名為 `developer`，這將在獲取憑證所需的路徑中發揮作用。要獲取憑證，請使用以下命令：

`vault read aws/creds/developer`

如果成功，Vault 應該返回一組客戶端可以用來直接與 AWS 交互的憑證。哇！

請記住，當租約（TTL）過期時，Vault 將返回並刪除 AWS 上的憑證，永久使它們失效。

## Day 2 運維

我想談的最後一件事是管理 Vault 用來訪問平台的憑證。動態密鑰引擎的全部目的是消除您的靜態、長期有效的憑證。然而，這裡的第一步是為 Vault 提供...靜態、長期有效的憑證來訪問平台？嗯...聽起來有點適得其反，對吧？如果該憑證被洩露或共享怎麼辦？

不用擔心，因為 Vault 為密鑰引擎提供了一個簡單的端點，允許 Vault 快速輪換該「root」憑證。您可以根據需要經常訪問此端點，以輪換 Vault 用來訪問平台的憑證。在這個範例中，您可以使用以下命令輪換我們上面提供的 AWS 憑證。

`vault write -f aws/config/rotate-root`

一旦您運行此命令，只有 AWS 和 Vault 知道憑證。沒有人類用戶擁有 root 憑證，甚至 Vault 管理員也無法讀回完整的訪問密鑰和秘密密鑰。此操作可以根據需要運行，以滿足您內部憑證輪換的安全政策。

請參閱 [Day 39](day39.md)
