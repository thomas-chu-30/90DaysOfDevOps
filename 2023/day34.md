# é‹è¡Œæ™‚è¨ªå•æ§åˆ¶

é‹è¡Œæ™‚è¨ªå•æ§åˆ¶åœ¨è¨ˆç®—æ©Ÿç³»çµ±ä¸­è‡³é—œé‡è¦ï¼Œå› ç‚ºå®ƒæœ‰åŠ©æ–¼ç¢ºä¿è¨ˆç®—æ©Ÿç³»çµ±é›†ç¾¤åŠå…¶ä¸Šé‹è¡Œçš„æ‡‰ç”¨ç¨‹å¼çš„å®‰å…¨æ€§å’Œå®Œæ•´æ€§ã€‚è¨ˆç®—æ©Ÿç³»çµ±æ˜¯ä¸€å€‹å…·æœ‰è¨±å¤šç§»å‹•éƒ¨ä»¶çš„è¤‡é›œç³»çµ±ï¼Œæ§åˆ¶å°é€™äº›çµ„ä»¶çš„è¨ªå•ä»¥é˜²æ­¢æœªæˆæ¬Šè¨ªå•æˆ–æƒ¡æ„æ´»å‹•è‡³é—œé‡è¦ã€‚

ä»¥ä¸‹æ˜¯é‹è¡Œæ™‚è¨ªå•æ§åˆ¶åœ¨è¨ˆç®—æ©Ÿç³»çµ±ä¸­å¾ˆé‡è¦çš„ä¸€äº›åŸå› ï¼š

ä¿è­·é›†ç¾¤å…å—æœªæˆæ¬Šè¨ªå•ï¼šè¨ªå•æ§åˆ¶ç¢ºä¿åªæœ‰æˆæ¬Šç”¨æˆ¶æˆ–é€²ç¨‹å¯ä»¥èˆ‡è¨ˆç®—æ©Ÿç³»çµ± API ä¼ºæœå™¨æˆ–é›†ç¾¤çµ„ä»¶äº¤äº’ã€‚æœªæˆæ¬Šè¨ªå•å¯èƒ½å°è‡´æ•¸æ“šæ´©éœ²ã€æ•æ„Ÿè³‡è¨Šè¢«ç›œæˆ–æ•´å€‹é›†ç¾¤å—åˆ°æå®³ã€‚

é˜²æ­¢è³‡æºæ¿«ç”¨ï¼šè¨ˆç®—æ©Ÿç³»çµ±ç®¡ç†å’Œåˆ†é…è³‡æºï¼Œå¦‚ CPUã€è¨˜æ†¶é«”å’Œç¶²è·¯é »å¯¬ã€‚è¨ªå•æ§åˆ¶æœ‰åŠ©æ–¼ç¢ºä¿é€™äº›è³‡æºå¾—åˆ°é©ç•¶ä½¿ç”¨ï¼Œä¸¦ä¸”æ‡‰ç”¨ç¨‹å¼ä¸æœƒä½¿ç”¨è¶…éå…¶éœ€è¦çš„è³‡æºã€‚

ç¢ºä¿åˆè¦æ€§ï¼šè¨ªå•æ§åˆ¶æœ‰åŠ©æ–¼ç¢ºä¿è¨ˆç®—æ©Ÿç³»çµ±åŠå…¶ä¸Šé‹è¡Œçš„æ‡‰ç”¨ç¨‹å¼ç¬¦åˆçµ„ç¹”æ”¿ç­–ã€è¡Œæ¥­æ¨™æº–å’Œç›£ç®¡è¦æ±‚ï¼Œå¦‚ HIPAAã€GDPR æˆ– PCI-DSSã€‚

ä¿ƒé€²å¯©è¨ˆå’Œå•è²¬åˆ¶ï¼šè¨ªå•æ§åˆ¶æä¾›èª°åœ¨ä½•æ™‚è¨ªå•äº†å“ªäº›è³‡æºçš„å¯©è¨ˆè¿½è¹¤ã€‚é€™äº›è³‡è¨Šå°æ–¼è¿½è¹¤å®‰å…¨äº‹ä»¶ã€æ•…éšœæ’é™¤å’Œåˆè¦å ±å‘Šå¾ˆæœ‰ç”¨ã€‚

ä¾‹å¦‚ï¼ŒKubernetes æä¾›äº†å¹¾ç¨®è¨ªå•æ§åˆ¶æ©Ÿåˆ¶ï¼ŒåŒ…æ‹¬èº«ä»½é©—è­‰æ©Ÿåˆ¶ã€è¨ªå•æ§åˆ¶ï¼ˆRBACï¼‰ã€å‡†å…¥æ§åˆ¶ã€ç¶²è·¯ç­–ç•¥ç­‰ã€‚æ­£ç¢ºé…ç½®å’Œç®¡ç†è¨ªå•æ§åˆ¶ä»¥ç¢ºä¿è¨ˆç®—æ©Ÿç³»çµ±é›†ç¾¤çš„å®‰å…¨æ€§å’Œå¯é æ€§å¾ˆé‡è¦ã€‚

## èº«ä»½é©—è­‰

èº«ä»½é©—è­‰æ˜¯é©—è­‰å˜—è©¦è¨ªå• Kubernetes API ä¼ºæœå™¨æˆ–é›†ç¾¤è³‡æºçš„ç”¨æˆ¶æˆ–é€²ç¨‹èº«ä»½çš„éç¨‹ã€‚Kubernetes æä¾›äº†å¹¾ç¨®èº«ä»½é©—è­‰æ©Ÿåˆ¶ï¼ŒåŒ…æ‹¬ X.509 å®¢æˆ¶ç«¯è­‰æ›¸ã€Bearer token å’Œ OpenID Connect (OIDC) tokenã€‚

X.509 å®¢æˆ¶ç«¯è­‰æ›¸æ˜¯ Kubernetes ä¸­æœ€å®‰å…¨ä¸”å»£æ³›ä½¿ç”¨çš„èº«ä»½é©—è­‰æ©Ÿåˆ¶ã€‚åœ¨é€™ç¨®æ–¹æ³•ä¸­ï¼Œå®¢æˆ¶ç«¯å‘ API ä¼ºæœå™¨æä¾›æœ‰æ•ˆçš„ X.509 å®¢æˆ¶ç«¯è­‰æ›¸ï¼ŒAPI ä¼ºæœå™¨æ ¹æ“šå—ä¿¡ä»»çš„è­‰æ›¸é ’ç™¼æ©Ÿæ§‹ï¼ˆCAï¼‰é©—è­‰è­‰æ›¸ã€‚

Bearer token æ˜¯ Kubernetes ä¸­å¦ä¸€ç¨®æµè¡Œçš„èº«ä»½é©—è­‰æ©Ÿåˆ¶ã€‚Bearer token æ˜¯ä¸€å€‹å­—å…ƒä¸²ï¼Œä»£è¡¨ç”¨æˆ¶æˆ–é€²ç¨‹çš„èº«ä»½ã€‚API ä¼ºæœå™¨æ ¹æ“šé…ç½®çš„ TokenReview API ä¼ºæœå™¨é©—è­‰ tokenã€‚

OIDC token æ˜¯ Kubernetes ä¸­è¼ƒæ–°çš„èº«ä»½é©—è­‰æ©Ÿåˆ¶ã€‚OIDC æ˜¯ OAuth 2.0 å”è­°ä¹‹ä¸Šçš„èº«ä»½å±¤ï¼Œä½¿ç”¨ç¬¬ä¸‰æ–¹èº«ä»½æä¾›è€…ï¼ˆå¦‚ Googleã€Azure æˆ– Oktaï¼‰å•Ÿç”¨èº«ä»½é©—è­‰å’Œæˆæ¬Šã€‚

Kubernetes é‚„æ”¯æ´ Webhook token èº«ä»½é©—è­‰ï¼Œå…¶ä¸­ API ä¼ºæœå™¨å°‡èº«ä»½é©—è­‰è«‹æ±‚ç™¼é€åˆ°é…ç½®çš„ webhook æœå‹™ã€‚Webhook æœå‹™é©—è­‰è«‹æ±‚ä¸¦è¿”å›æŒ‡ç¤ºèº«ä»½é©—è­‰æˆåŠŸæˆ–å¤±æ•—çš„éŸ¿æ‡‰ã€‚

é™¤äº†èº«ä»½é©—è­‰ä¹‹å¤–ï¼ŒKubernetes é‚„æä¾›æ§åˆ¶å°ç‰¹å®šè³‡æºè¨ªå•çš„æˆæ¬Šæ©Ÿåˆ¶ã€‚åŸºæ–¼è§’è‰²çš„è¨ªå•æ§åˆ¶ï¼ˆRBACï¼‰æ˜¯ Kubernetes ä¸­æœ€å»£æ³›ä½¿ç”¨çš„æˆæ¬Šæ©Ÿåˆ¶ã€‚RBAC å…è¨±ç®¡ç†å“¡æ ¹æ“šç”¨æˆ¶æˆ–ç”¨æˆ¶çµ„çš„å·¥ä½œè·èƒ½æˆ–è·è²¬ç‚ºä»–å€‘å®šç¾©è§’è‰²å’Œæ¬Šé™ã€‚

Kubernetes é‚„æä¾›å…¶ä»–æˆæ¬Šæ©Ÿåˆ¶ï¼Œå¦‚åŸºæ–¼å±¬æ€§çš„è¨ªå•æ§åˆ¶ï¼ˆABACï¼‰å’Œç¯€é»æˆæ¬Šã€‚

èº«ä»½é©—è­‰å’Œæˆæ¬Šæ˜¯ä¿è­· Kubernetes é›†ç¾¤çš„é‡è¦çµ„æˆéƒ¨åˆ†ã€‚å®ƒå€‘æœ‰åŠ©æ–¼ç¢ºä¿åªæœ‰æˆæ¬Šç”¨æˆ¶å’Œé€²ç¨‹å¯ä»¥è¨ªå•é›†ç¾¤è³‡æºï¼Œä¸¦é˜²æ­¢æœªæˆæ¬Šè¨ªå•ã€æ•¸æ“šæ´©éœ²å’Œå…¶ä»–å®‰å…¨å¨è„…ã€‚

Kubernetes ç®¡ç†å“¡æ‡‰è©²ä»”ç´°é…ç½®å’Œç®¡ç†èº«ä»½é©—è­‰å’Œæˆæ¬Šï¼Œä»¥ç¢ºä¿å…¶é›†ç¾¤çš„å®‰å…¨æ€§å’Œå¯é æ€§ã€‚æœ€ä½³å¯¦è¸åŒ…æ‹¬ä½¿ç”¨å®‰å…¨èº«ä»½é©—è­‰æ©Ÿåˆ¶ï¼ˆå¦‚ X.509 è­‰æ›¸ï¼‰ã€é™åˆ¶å° Kubernetes API ä¼ºæœå™¨çš„è¨ªå•ï¼Œä»¥åŠå•Ÿç”¨ RBAC ä¾†æ§åˆ¶å°è³‡æºçš„è¨ªå•ã€‚

Kubernetes èº«ä»½é©—è­‰æ˜¯ä¸€å€‹è¤‡é›œçš„ä¸»é¡Œï¼Œéœ€è¦æ·±å…¥ç†è§£åº•å±¤å®‰å…¨æ©Ÿåˆ¶å’Œå”è­°ã€‚Kubernetes ç®¡ç†å“¡å’Œå®‰å…¨å°ˆæ¥­äººå“¡æ‡‰è©²åŠæ™‚äº†è§£æœ€æ–°çš„èº«ä»½é©—è­‰å’Œæˆæ¬Šæœ€ä½³å¯¦è¸å’Œå®‰å…¨æ›´æ–°ï¼Œä»¥ä¿æŒå…¶é›†ç¾¤çš„å®‰å…¨å’Œåˆè¦ã€‚

æ¯«ç„¡ç–‘å•ï¼Œèº«ä»½é©—è­‰ token å’Œæ†‘è­‰æ˜¯ Kubernetes é›†ç¾¤å®‰å…¨çš„åŸºçŸ³ã€‚é€™å°æ–¼ä»»ä½•è¨ˆç®—æ©Ÿç³»çµ±çš„è¨ªå•æ§åˆ¶éƒ½æ˜¯å¦‚æ­¤ã€‚

ä»¥ä¸‹æ˜¯ä¸€å€‹ç¯„ä¾‹ï¼Œèªªæ˜ä¸åŒçš„æ†‘è­‰å¦‚ä½•ä»¥è¨­è¨ˆæœªè¨ˆåŠƒçš„æ–¹å¼ä½¿ç”¨ã€‚

æˆ‘å‡è¨­æ‚¨çš„ Minikube ä»åœ¨é‹è¡Œã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç²å– Kube-proxy çµ„ä»¶çš„ Kubernetes Service Account tokenï¼š
```bash
kubectl -n kube-system exec $(kubectl get pods -n kube-system | grep kube-proxy | head -n 1 | awk '{print $1}') -- cat /var/run/secrets/kubernetes.io/serviceaccount/token
```

æ³¨æ„ï¼šå¦‚æœæ‚¨æƒ³äº†è§£æ›´å¤šé—œæ–¼æ­¤ JWT çš„å…§å®¹ï¼Œè«‹è¨ªå• [jwt.io](https://jwt.io/) ä¸¦è§£ææ‚¨ä½¿ç”¨ä¸Šä¸€å€‹å‘½ä»¤ç²å¾—çš„ tokenï¼

![](images/day34-1.png)

æˆ‘å€‘å°‡åœ¨é€™è£¡çœ‹åˆ°å¦‚æœç²å¾—ä¸Šè¿° tokenï¼Œå†’å……å…¶ä»–äººæ˜¯å¤šéº¼å®¹æ˜“ã€‚æˆ‘å€‘å°‡è¨­ç½® `kubectl` ä½¿ç”¨æ­¤ token è€Œä¸æ˜¯é è¨­æ†‘è­‰ã€‚

```bash
export KUBE_PROXY_POD_NAME=`kubectl get pods -n kube-system | grep kube-proxy | head -n 1 | awk '{print $1}'`
export TOKEN=`kubectl -n kube-system exec $KUBE_PROXY_POD_NAME -- cat /var/run/secrets/kubernetes.io/serviceaccount/token`
export API_SERVER_URL=`kubectl config view --minify --output jsonpath="{.clusters[*].cluster.server}"`
kubectl -n kube-system exec $KUBE_PROXY_POD_NAME -- cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt > /tmp/ca.crt
kubectl config set-cluster access-test --server=$API_SERVER_URL --certificate-authority=/tmp/ca.crt
kubectl config set-context access-test --cluster=access-test
kubectl config set-credentials user --token=$TOKEN
kubectl config set-context access-test --user=user
kubectl config use-context access-test
```

ç¾åœ¨æˆ‘å€‘å·²ç¶“è¨­ç½®äº† `kubectl` ä½¿ç”¨æˆ‘å€‘å¾ Kube-proxyã€Œç«Šå–ã€çš„ä¸Šè¿° tokenï¼Œæˆ‘å€‘å¯ä»¥çœ‹åˆ°å®ƒåœ¨å¯¦éš›æ“ä½œä¸­ï¼š
```bash
kubectl get nodes
```

ç§ï¼ğŸ˜„

é€™æ˜¯ä¸€å€‹ç°¡å–®çš„ç¯„ä¾‹ï¼Œèªªæ˜æ†‘è­‰åœ¨è¢«ç›œçš„æƒ…æ³ä¸‹å¦‚ä½•è¢«æƒ¡æ„è¡Œç‚ºè€…ä½¿ç”¨ã€‚

ï¼ˆå¦‚æœæ‚¨ä½¿ç”¨äº† Minikubeï¼Œè«‹é€šé `kubectl config use-context minikube` æ¢å¾©åˆ°åŸå§‹ä¸Šä¸‹æ–‡ï¼‰

## æˆæ¬Š

è®“æˆ‘å€‘ç¹¼çºŒä¸Šé¢çš„æ—…ç¨‹ï¼Œçœ‹çœ‹èº«ä»½é©—è­‰ä¹‹å¾Œæ˜¯ä»€éº¼ã€‚

Kubernetes åŸºæ–¼è§’è‰²çš„è¨ªå•æ§åˆ¶ï¼ˆRBACï¼‰æ˜¯ä¸€ç¨®ç”¨æ–¼æ§åˆ¶ Kubernetes é›†ç¾¤å…§è³‡æºè¨ªå•çš„å®‰å…¨æ©Ÿåˆ¶ã€‚RBAC ç”¨æ–¼å®šç¾©ç¢ºå®šç”¨æˆ¶å’Œæœå‹™å¸³æˆ¶å¯ä»¥åœ¨ Kubernetes è³‡æºä¸ŠåŸ·è¡Œå“ªäº›æ“ä½œçš„æ”¿ç­–ã€‚

åœ¨ Kubernetes ä¸­ï¼ŒRBAC é€šéå®šç¾©å…©ç¨®é¡å‹çš„ä¸»è¦å°è±¡ä¾†å·¥ä½œï¼šè§’è‰²å’Œè§’è‰²ç¶å®šã€‚è§’è‰²æ˜¯å¯ä»¥æ‡‰ç”¨æ–¼ Kubernetes é›†ç¾¤ä¸­ä¸€å€‹æˆ–å¤šå€‹è³‡æºçš„æ¬Šé™é›†åˆã€‚è§’è‰²ç¶å®šç”¨æ–¼å°‡è§’è‰²æˆäºˆç”¨æˆ¶ã€ç”¨æˆ¶çµ„æˆ–æœå‹™å¸³æˆ¶ã€‚

ç•¶ç”¨æˆ¶æˆ–æœå‹™å¸³æˆ¶å˜—è©¦åœ¨ Kubernetes ä¸­çš„è³‡æºä¸ŠåŸ·è¡Œæ“ä½œæ™‚ï¼ŒKubernetes API ä¼ºæœå™¨æœƒæª¢æŸ¥ç›¸é—œè§’è‰²ç¶å®šä¸­å®šç¾©çš„æ¬Šé™ã€‚å¦‚æœç”¨æˆ¶æˆ–æœå‹™å¸³æˆ¶è¢«æˆæ¬ŠåŸ·è¡Œè©²æ“ä½œï¼ŒAPI ä¼ºæœå™¨æœƒæˆäºˆè¨ªå•æ¬Šé™ã€‚å¦‚æœç”¨æˆ¶æˆ–æœå‹™å¸³æˆ¶æœªè¢«æˆæ¬Šï¼ŒAPI ä¼ºæœå™¨æœƒæ‹’çµ•è¨ªå•ã€‚

RBAC å¯ç”¨æ–¼æ§åˆ¶å°å„ç¨® Kubernetes è³‡æºçš„è¨ªå•ï¼ŒåŒ…æ‹¬ Podã€Serviceã€Deployment ç­‰ã€‚RBAC æ”¿ç­–å¯ä»¥åœ¨ Kubernetes é›†ç¾¤çš„å„å€‹ç´šåˆ¥å®šç¾©ï¼ŒåŒ…æ‹¬é›†ç¾¤ç´šåˆ¥ã€å‘½åç©ºé–“ç´šåˆ¥å’Œå–®å€‹è³‡æºç´šåˆ¥ã€‚

RBAC å¯ä»¥ä½¿ç”¨ Kubernetes API æˆ–ä½¿ç”¨ `kubectl` ç­‰å·¥å…·é€²è¡Œé…ç½®ã€‚ä½¿ç”¨ RBACï¼Œç®¡ç†å“¡å¯ä»¥å¯¦æ–½åš´æ ¼çš„å®‰å…¨æ”¿ç­–ï¼Œä¸¦æœ‰åŠ©æ–¼ç¢ºä¿åªæœ‰æˆæ¬Šç”¨æˆ¶å’Œæœå‹™å¸³æˆ¶èƒ½å¤ è¨ªå•å’Œä¿®æ”¹ Kubernetes è³‡æºï¼Œå¾è€Œé™ä½æœªæˆæ¬Šè¨ªå•å’Œæ•¸æ“šæ´©éœ²çš„é¢¨éšªã€‚

åœ¨ä¸Šé¢çš„ Kube-proxy æ¡ˆä¾‹ä¸­ï¼Œæ­¤å·¥ä½œè² è¼‰æœ‰ä¸€å€‹æœå‹™å¸³æˆ¶ã€‚æˆ‘å€‘æ€éº¼çŸ¥é“ï¼Ÿé‹è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
```bash
kubectl -n kube-system get daemonset kube-proxy -o=jsonpath='{.spec.template.spec.serviceAccount}'
```
å®ƒè¿”å› `kube-proxy` ä½œç‚ºé—œè¯çš„æœå‹™å¸³æˆ¶ã€‚

å¦‚æœæ‚¨åˆ—å‡ºæ‰€æœ‰ `ClusterRoleBindings`ï¼Œæ‚¨å°‡çœ‹åˆ°æ­¤æœå‹™å¸³æˆ¶èˆ‡ `kubeadm:node-proxier` å’Œ `system:node-proxier` `ClusterRoles` ç¶å®šã€‚
```bash
kubectl get clusterrolebindings -o wide | grep kube-proxy
```

æ‚¨å¯ä»¥é€šéä½¿ç”¨ `kubectl` æŸ¥è©¢å®ƒå€‘ä¾†æŸ¥çœ‹é€™äº› `ClusterRoles` å…è¨±æ­¤æœå‹™å¸³æˆ¶åŸ·è¡Œå“ªäº›æ“ä½œï¼š
```bash
kubectl get clusterrole system:node-proxier -o yaml
```

æ‚¨å°‡çœ‹åˆ°æ­¤è§’è‰²å•Ÿç”¨ï¼š
* åœ¨ `endpoint` å’Œ `service` å°è±¡ä¸Šåˆ—å‡ºå’Œç›£è¦–
* åœ¨ `nodes` ä¸Šç²å–ã€åˆ—å‡ºå’Œç›£è¦–
* åœ¨ `events` ä¸Šå‰µå»ºã€ä¿®è£œã€æ›´æ–°

é€™å°±æ˜¯ç‚ºä»€éº¼æˆ‘å€‘åœ¨ä¸Šä¸€ç¯€ä¸­åŸ·è¡Œäº† `kubectl get nodes`ã€‚

å¦ä¸€å€‹ç¯„ä¾‹æ˜¯åç‚º `system:controller:deployment-controller` çš„ ClusterRoleï¼Œå®ƒæ˜¯èˆ‡ Deployment Controller çµ„ä»¶çš„æœå‹™å¸³æˆ¶é—œè¯çš„è§’è‰²ï¼Œè©²çµ„ä»¶è² è²¬ç®¡ç† `Deployments` çš„ `ReplicaSets`ï¼Œå®ƒå€‘éœ€è¦ç¢ºä¿ä¸‹æ¸¸å°è±¡ï¼ˆ`ReplicaSet`ï¼‰å§‹çµ‚èˆ‡ `Deployments` çš„å®šç¾©ä¿æŒä¸€è‡´ã€‚

```bash
kubectl get clusterrole system:controller:deployment-controller -o yaml
```

åœ¨é€™è£¡ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°ä¾‹å¦‚æ­¤è§’è‰²æˆæ¬Šä¸»é«”åœ¨ `ReplicaSets` ä¸Šå‰µå»ºã€åˆªé™¤ã€æ›´æ–°ç­‰ï¼Œé€™è€ƒæ…®åˆ°æ­¤çµ„ä»¶å…·æœ‰çš„åŠŸèƒ½æ˜¯æœ‰æ„ç¾©çš„ã€‚

Kubernetes RBAC æ˜¯ä¸€å€‹å¥½çš„æˆæ¬Šç³»çµ±å—ï¼Ÿæ˜¯çš„ï¼Œä½†æ˜¯...
* æœ‰æ™‚ç®¡ç†èµ·ä¾†å¯èƒ½æœ‰é»è¤‡é›œ
* æˆæ¬Šå¯ä»¥çµ¦äºˆå‹•è©å’Œå°è±¡çš„çµ„åˆï¼ˆæ‚¨å¯ä»¥å°ä»€éº¼åšä»€éº¼ï¼‰

å¾Œè€…ä¸æ˜¯ä¸€å€‹æ˜é¡¯çš„é™åˆ¶ã€‚æ‚¨å¯ä»¥å…è¨±æŸäººå‰µå»º Podï¼Œä½†æ‚¨ç„¡æ³•é™åˆ¶åŒä¸€ä¸»é«”åƒ…å‰µå»ºéç‰¹æ¬Š Podï¼Œå› ç‚ºå…©è€…éƒ½æ˜¯ç›¸åŒçš„å°è±¡ã€‚

é€™å°‡æˆ‘å€‘å¸¶åˆ°ä»Šå¤©å…§å®¹çš„æœ€å¾Œä¸€éƒ¨åˆ†ã€‚

## é‹è¡Œæ™‚å‡†å…¥æ§åˆ¶å™¨

åœ¨ Kubernetes ä¸­ï¼Œå‡†å…¥æ§åˆ¶å™¨æ˜¯ä¸€ç¨®åœ¨è«‹æ±‚è¢«è™•ç†ä¹‹å‰æ””æˆªå° Kubernetes API ä¼ºæœå™¨çš„è«‹æ±‚çš„æ’ä»¶é¡å‹ï¼Œå…è¨±ç®¡ç†å“¡å°æ­£åœ¨å‰µå»ºæˆ–ä¿®æ”¹çš„è³‡æºå¯¦æ–½è‡ªå®šç¾©æ”¿ç­–å’Œé™åˆ¶ã€‚

å‡†å…¥æ§åˆ¶å™¨ç”¨æ–¼åœ¨è³‡æºæŒä¹…åŒ–åˆ° Kubernetes API ä¼ºæœå™¨ä¹‹å‰é©—è­‰å’Œä¿®æ”¹è³‡æºè¦ç¯„ã€‚å®ƒå€‘å¯ç”¨æ–¼å¯¦æ–½å»£æ³›çš„æ”¿ç­–ï¼Œä¾‹å¦‚ç¢ºä¿æ‰€æœ‰ Pod éƒ½æœ‰ç‰¹å®šæ¨™ç±¤ã€é˜²æ­¢å‰µå»ºç‰¹æ¬Šå®¹å™¨æˆ–é™åˆ¶å°æŸäº›å‘½åç©ºé–“çš„è¨ªå•ã€‚

Kubernetes ä¸­çš„å‡†å…¥æ§åˆ¶å™¨å¯ä»¥æ˜¯ä»¥ä¸‹é¡å‹ä¹‹ä¸€æˆ–å…©è€…ï¼š
* MutatingAdmissionWebhookï¼šæ­¤æ§åˆ¶å™¨å¯ä»¥åœ¨è«‹æ±‚æŒä¹…åŒ–åˆ° Kubernetes API ä¼ºæœå™¨ä¹‹å‰ä¿®æ”¹æˆ–è®Šç•°è«‹æ±‚ã€‚
* ValidatingAdmissionWebhookï¼šæ­¤æ§åˆ¶å™¨å¯ä»¥æ ¹æ“šè‡ªå®šç¾©æ”¿ç­–é©—è­‰æˆ–æ‹’çµ•å° Kubernetes API ä¼ºæœå™¨çš„è«‹æ±‚ã€‚

å‡†å…¥æ§åˆ¶å™¨å¯ä»¥è‡ªå®šç¾©æˆ–æ“´å±•ä»¥æ»¿è¶³çµ„ç¹”æˆ–æ‡‰ç”¨ç¨‹å¼çš„ç‰¹å®šéœ€æ±‚ã€‚é€šéä½¿ç”¨å‡†å…¥æ§åˆ¶å™¨ï¼Œç®¡ç†å“¡å¯ä»¥ç¢ºä¿ Kubernetes é›†ç¾¤ä¸­çš„è³‡æºç¬¦åˆç‰¹å®šçš„æ”¿ç­–å’Œå®‰å…¨è¦æ±‚ï¼Œæœ‰åŠ©æ–¼é™ä½å®‰å…¨æ¼æ´çš„é¢¨éšªä¸¦ç¢ºä¿ä¸€è‡´ä¸”å®‰å…¨çš„éƒ¨ç½²ç’°å¢ƒã€‚

æœ‰å…©å€‹å¾ˆå¥½çš„é–‹æºå‡†å…¥æ§åˆ¶å™¨å°ˆæ¡ˆç¯„ä¾‹ï¼š[OPA Gatekeeper](https://open-policy-agent.github.io/gatekeeper/website/docs/) å’Œ [Kyverno](https://kyverno.io/)ã€‚ä»Šå¤©æˆ‘å€‘å°‡ä½¿ç”¨ Kyvernoã€‚

Kyverno å…è¨±ç”¨æˆ¶å°‡æ”¿ç­–å®šç¾©ç‚ºä»£ç¢¼ï¼Œä¸¦å°‡å…¶æ‡‰ç”¨æ–¼ Kubernetes è³‡æºï¼Œå¦‚ Podã€Deploymentã€Service ç­‰ã€‚æ”¿ç­–å¯ä»¥ç”¨ YAML æˆ– JSON ç·¨å¯«ï¼Œå¯ä»¥è‡ªå®šç¾©ä»¥å¯¦æ–½çµ„ç¹”æˆ–æ‡‰ç”¨ç¨‹å¼çš„ç‰¹å®šè¦æ±‚ã€‚Kyverno æ”¿ç­–å¯ä»¥åœ¨å‰µå»ºæ™‚æ‡‰ç”¨æ–¼è³‡æºï¼Œæˆ–æ ¹æ“šéœ€è¦åœ¨ä»¥å¾Œæ›´æ–°ã€‚

Kyverno æ˜¯ä¸€å€‹å¼·å¤§çš„å·¥å…·ï¼Œå¯ä»¥å¹«åŠ©ç¢ºä¿ Kubernetes è³‡æºæ ¹æ“šçµ„ç¹”æ”¿ç­–å’Œæœ€ä½³å¯¦è¸é€²è¡Œé…ç½®å’Œç®¡ç†ã€‚å®ƒå¯ä»¥å¹«åŠ©æ”¹å–„ Kubernetes éƒ¨ç½²çš„å®‰å…¨æ€§ã€åˆè¦æ€§å’Œä¸€è‡´æ€§ï¼ŒåŒæ™‚ä¹Ÿç°¡åŒ–äº†ç®¡ç†å“¡å’Œé–‹ç™¼äººå“¡çš„æ”¿ç­–ç®¡ç†ã€‚

è¦åœ¨æˆ‘å€‘çš„ Minikube ä¸Šå®‰è£ Kyvernoï¼Œè«‹ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
```bash
helm repo add kyverno https://kyverno.github.io/kyverno/
helm repo update
helm install kyverno kyverno/kyverno -n kyverno --create-namespace --set replicaCount=1
helm install kyverno-policies kyverno/kyverno-policies -n kyverno
```

è®“æˆ‘å€‘å‰µå»ºä¸€å€‹é˜²æ­¢ç‰¹æ¬Š Pod çš„æ”¿ç­–ã€‚
```bash
kubectl apply -f - << EOF
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: no-privileged-containers
  annotations:
    policies.kyverno.io/title: No Privileged Containers
    policies.kyverno.io/subject: Pod
spec:
  validationFailureAction: Enforce
  rules:
    - name: no-privileged-containers
      match:
        any:
        - resources:
            kinds:
              - Pod
      validate:
        message: >-
          Privileged containers are not allowed!
        pattern:
          spec:
            containers:
              - =(securityContext):
                  =(privileged): "false"
EOF
```

æ‚¨å¯ä»¥çœ‹åˆ°æ­¤æ”¿ç­–é©—è­‰ Pod ä¸­ `securityContext` æ¬„ä½ä¸‹çš„ `privileged` æ¨™èªŒç‚º falseã€‚

ç¾åœ¨å¦‚æœæˆ‘å˜—è©¦å•Ÿå‹•ä¸€å€‹ç‰¹æ¬Š Podï¼Œå®ƒå°‡å¤±æ•—ã€‚è©¦è©¦çœ‹ï¼š

```bash
kubectl apply -f - << EOF
apiVersion: v1
kind: Pod
metadata:
  name: privileged-container-demo
spec:
  containers:
  - name: privileged-container-demo
    image: nginx:latest
    securityContext:
      privileged: true
EOF
```

é€™æ‡‰è©²æœƒå¤±æ•—ï¼ˆæ²’æœ‰ Kyverno æ”¿ç­–ï¼Œé€™å°‡æˆåŠŸï¼‰ã€‚

```
admission webhook "validate.kyverno.svc-fail" denied the request: 

policy Pod/default/privileged-container-demo for resource violation: 

no-privileged-containers:
  no-privileged-containers: 'validation error: Privileged containers are not allowed!.
    rule no-privileged-containers failed at path /spec/containers/0/securityContext/privileged/'
```

æˆ‘å¸Œæœ›é€™å€‹ç°¡çŸ­çš„ä»‹ç´¹è®“æ‚¨ç¨å¾®äº†è§£å‡†å…¥æ§åˆ¶å™¨å¦‚ä½•å¹«åŠ©æ‚¨åœ¨ Kubernetes é›†ç¾¤ä¸Šå¯¦æ–½é‹è¡Œæ™‚è¦å‰‡ï¼

è«‹åƒé–± [Day 35](day35.md)ã€‚
